<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Contenu | Coach Agile Toolkit</title>

    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">

    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/style.css">


</head>

<body>

    <!-- HEADER (charg√© dynamiquement) -->
    <div id="header-placeholder"></div>

    <!-- PAGE CONTAINER -->
    <div class="page-container">
        <!-- SIDEBAR (charg√© dynamiquement) -->
        <div id="sidebar-placeholder"></div>

        <!-- MAIN CONTENT -->
        <main class="main-content">

        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="index.html">Accueil</a>
            <span class="breadcrumb-separator">/</span>
            <a href="#" id="breadcrumbCategory">Cat√©gorie</a>
            <span class="breadcrumb-separator">/</span>
            <span id="breadcrumbContent">Contenu</span>
        </nav>

        <!-- Article Header -->
        <header class="article-header">
            <h1 id="articleTitle">Chargement...</h1>
            <div class="article-meta">
                <span id="articleDate"></span>
                <span id="articleReadTime"></span>
            </div>
        </header>

        <!-- Table of Contents (optionnel) -->
        <aside class="toc" id="toc" style="display: none;">
            <div class="toc-title">üìã Table des mati√®res</div>
            <ul id="tocList"></ul>
        </aside>

        <!-- Markdown Content -->
        <article class="markdown-content" id="markdownContent">
            <p>Chargement du contenu...</p>
        </article>

        <!-- Navigation Prev/Next -->
        <nav class="content-navigation">
            <a href="#" class="nav-prev" id="navPrev" style="display: none;">
                ‚Üê Article pr√©c√©dent
            </a>
            <a href="#" class="nav-next" id="navNext" style="display: none;">
                Article suivant ‚Üí
            </a>
        </nav>

            <!-- FOOTER (charg√© dynamiquement) -->
            <div id="footer-placeholder"></div>
        </main>
    </div>

    <!-- SCRIPTS -->
    <!-- Biblioth√®ques externes pour le parsing Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <script src="assets/js/partials-loader.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/navigation.js"></script>
    <script src="assets/js/markdown-parser.js"></script>
    <script src="assets/js/search.js"></script>
    <script src="assets/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const categoryId = urlParams.get('cat');
            const fileSlug = urlParams.get('file');

            if (!categoryId || !fileSlug) {
                window.location.href = 'index.html';
                return;
            }

            // Charger la config pour le breadcrumb
            const config = await fetch('config/config.json').then(r => r.json());
            const category = config.categories.find(c => c.id === categoryId);

            if (category) {
                const breadcrumbCat = document.getElementById('breadcrumbCategory');
                breadcrumbCat.textContent = category.title;
                breadcrumbCat.href = `category.html?cat=${categoryId}`;
            }

            await loadMarkdownContent(categoryId, fileSlug);
        });

        async function loadMarkdownContent(categoryId, fileSlug) {
            try {
                // Charger le fichier Markdown
                const response = await fetch(`content/${categoryId}/${fileSlug}.md`);
                if (!response.ok) throw new Error('Fichier non trouv√©');

                const markdownText = await response.text();

                // Extraire le front-matter YAML
                let frontMatter = {};
                let markdown = markdownText;

                if (markdownText.startsWith('---')) {
                    const endOfFrontMatter = markdownText.indexOf('---', 3);
                    if (endOfFrontMatter !== -1) {
                        const frontMatterText = markdownText.substring(3, endOfFrontMatter).trim();
                        markdown = markdownText.substring(endOfFrontMatter + 3).trim();

                        // Parser le front-matter (simple)
                        frontMatterText.split('\n').forEach(line => {
                            const colonIndex = line.indexOf(':');
                            if (colonIndex > 0) {
                                const key = line.substring(0, colonIndex).trim();
                                const value = line.substring(colonIndex + 1).trim().replace(/^["']|["']$/g, '');
                                frontMatter[key] = value;
                            }
                        });
                    }
                }

                // Parser et afficher le markdown
                let html;
                if (typeof marked !== 'undefined') {
                    // Configurer marked pour g√©rer les blocs de code Mermaid et les images avec l√©gendes
                    const renderer = new marked.Renderer();
                    const originalCodeRenderer = renderer.code.bind(renderer);
                    
                    renderer.code = function(code, language) {
                        if (language === 'mermaid') {
                            return `<div class="mermaid">${code}</div>`;
                        }
                        return originalCodeRenderer(code, language);
                    };
                    
                    // Renderer personnalis√© pour les images avec l√©gendes
                    renderer.image = function(href, title, text) {
                        if (text && text.trim()) {
                            // Si il y a un texte alt, cr√©er une figure avec l√©gende
                            return `<figure class="image-with-caption">
                                <img src="${href}" alt="${text}" loading="lazy"${title ? ` title="${title}"` : ''}>
                                <figcaption>${text}</figcaption>
                            </figure>`;
                        } else {
                            // Sinon, image simple
                            return `<img src="${href}" alt="" loading="lazy"${title ? ` title="${title}"` : ''}>`;
                        }
                    };
                    
                    // Utiliser marked.js avec le renderer personnalis√©
                    html = marked.parse(markdown, { renderer });
                } else {
                    // Fallback : parser maison
                    html = parseMarkdown(markdown);
                }
                
                document.getElementById('markdownContent').innerHTML = html;
                
                // Styliser les citations avec auteur
                if (typeof styleBlockquotesWithAuthor === 'function') {
                    styleBlockquotesWithAuthor();
                }
                
                // Styliser les images avec l√©gendes
                if (typeof styleImagesWithCaptions === 'function') {
                    styleImagesWithCaptions();
                }
                
                // Initialiser Mermaid pour les diagrammes
                if (typeof initMermaid === 'function') {
                    initMermaid();
                }

                // Ajouter les boutons de copie aux blocs de code
                if (typeof addCopyButtonsToCodeBlocks === 'function') {
                    addCopyButtonsToCodeBlocks();
                }

                // Utiliser le titre du front-matter ou extraire du H1
                const title = frontMatter.title || document.querySelector('.markdown-content h1')?.textContent || fileSlug;

                document.getElementById('articleTitle').textContent = title;
                document.getElementById('pageTitle').textContent = `${title} | Coach Agile Toolkit`;
                document.getElementById('breadcrumbContent').textContent = title;

                // Ne pas enlever le premier H1 - il fait partie du contenu

                // Afficher les tags si pr√©sents
                if (frontMatter.tags) {
                    const tagsArray = frontMatter.tags.replace(/[\[\]"]/g, '').split(',').map(t => t.trim());
                    const tagsHtml = tagsArray.map(tag => `<span class="content-card-tag">#${tag}</span>`).join('');
                    document.querySelector('.article-meta').innerHTML += `<div class="article-tags">${tagsHtml}</div>`;
                }

                // G√©n√©rer la table des mati√®res
                generateTOC();

                // Ajouter au historique
                addToRecents('content', `${categoryId}/${fileSlug}`, title);

            } catch (error) {
                console.error('Erreur chargement Markdown:', error);
                document.getElementById('markdownContent').innerHTML = `
          <div class="error-state">
            <h2>Contenu introuvable</h2>
            <p>Le contenu demand√© n'existe pas ou a √©t√© d√©plac√©.</p>
            <a href="category.html?cat=${categoryId}" class="btn btn-primary">Retour √† la cat√©gorie</a>
          </div>
        `;
            }
        }

        function generateTOC() {
            const headings = document.querySelectorAll('.markdown-content h1, .markdown-content h2, .markdown-content h3');
            if (headings.length === 0) return;

            const toc = document.getElementById('toc');
            const tocList = document.getElementById('tocList');

            toc.style.display = 'block';
            tocList.innerHTML = '';

            headings.forEach((heading, index) => {
                const id = `heading-${index}`;
                heading.id = id;

                const li = document.createElement('li');
                // Indentation selon le niveau de titre
                if (heading.tagName === 'H1') {
                    li.style.paddingLeft = '0';
                    li.style.fontWeight = 'bold';
                } else if (heading.tagName === 'H2') {
                    li.style.paddingLeft = 'var(--space-sm, 8px)';
                } else if (heading.tagName === 'H3') {
                    li.style.paddingLeft = 'var(--space-md, 16px)';
                }

                const a = document.createElement('a');
                a.href = `#${id}`;
                a.textContent = heading.textContent;

                li.appendChild(a);
                tocList.appendChild(li);
            });
        }
    </script>
</body>

</html>