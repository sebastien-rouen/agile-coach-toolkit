<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="CatÃ©gorie - Coach Agile Toolkit">

    <title id="pageTitle">CatÃ©gorie | Coach Agile Toolkit</title>

    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">

    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>

    <!-- HEADER (chargÃ© dynamiquement) -->
    <div id="header-placeholder"></div>

    <!-- PAGE CONTAINER -->
    <div class="page-container">
        <!-- SIDEBAR (chargÃ© dynamiquement) -->
        <div id="sidebar-placeholder"></div>

        <!-- MAIN CONTENT -->
        <main class="main-content">

            <!-- Breadcrumb -->
            <nav class="breadcrumb" aria-label="Fil d'Ariane">
                <a href="index.html">Accueil</a>
                <span class="breadcrumb-separator">/</span>
                <span id="breadcrumbCategory">CatÃ©gorie</span>
            </nav>

            <!-- Category Header -->
            <header class="category-header" id="categoryHeader">
                <div class="category-header-content">
                    <div class="category-icon-large" id="categoryIcon">ðŸŽ¯</div>
                    <div>
                        <h1 class="category-title" id="categoryTitle">Chargement...</h1>
                        <p class="category-subtitle" id="categorySubtitle"></p>
                    </div>
                </div>
                <div class="category-meta">
                    <span class="badge" id="contentCount">0 ressources</span>
                </div>
            </header>

            <!-- Tabs : Articles / Outils / Templates -->
            <div class="content-tabs-wrapper">
                <div class="content-tabs">
                    <button class="content-tab active" data-type="all">Tout</button>
                    <button class="content-tab" data-type="articles">Articles</button>
                    <button class="content-tab" data-type="tools">Outils</button>
                    <button class="content-tab" data-type="templates">Templates</button>
                </div>
                
                <!-- View Switcher -->
                <div class="view-switcher">
                    <button class="view-btn" data-view="grid" title="Vue grille">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                    <button class="view-btn active" data-view="list" title="Vue liste">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="8" y1="6" x2="21" y2="6"></line>
                            <line x1="8" y1="12" x2="21" y2="12"></line>
                            <line x1="8" y1="18" x2="21" y2="18"></line>
                            <line x1="3" y1="6" x2="3.01" y2="6"></line>
                            <line x1="3" y1="12" x2="3.01" y2="12"></line>
                            <line x1="3" y1="18" x2="3.01" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Content List -->
            <div class="content-list" id="contentList" data-view="list">
                <!-- GÃ©nÃ©rÃ© dynamiquement depuis content/{category}/ -->
            </div>

            <!-- FOOTER (chargÃ© dynamiquement) -->
            <div id="footer-placeholder"></div>
        </main>
    </div>

    <!-- SCRIPTS -->
    <script src="assets/js/partials-loader.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/navigation.js"></script>
    <script src="assets/js/markdown-parser.js"></script>
    <script src="assets/js/search.js"></script>
    <script src="assets/js/main.js"></script>
    <script>
        // Logique spÃ©cifique Ã  la page catÃ©gorie
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const categoryId = urlParams.get('cat');

            if (!categoryId) {
                window.location.href = 'index.html';
                return;
            }

            // Charger la config
            const config = await fetch('config/config.json').then(r => r.json());
            const category = config.categories.find(c => c.id === categoryId);

            if (!category) {
                window.location.href = 'index.html';
                return;
            }

            // Attendre que les partiels soient chargÃ©s avant d'accÃ©der aux Ã©lÃ©ments du header
            await new Promise(resolve => {
                if (document.querySelector('#favoriteBtn')) {
                    resolve();
                } else {
                    document.addEventListener('partialsLoaded', resolve, { once: true });
                }
            });

            // Remplir le header
            document.getElementById('pageTitle').textContent = `${category.title} | Coach Agile Toolkit`;
            document.getElementById('categoryIcon').textContent = category.emoji;
            document.getElementById('categoryTitle').textContent = category.title;
            document.getElementById('categorySubtitle').textContent = category.subtitle;
            document.getElementById('breadcrumbCategory').textContent = category.title;

            // Appliquer la couleur de la catÃ©gorie
            const categoryHeader = document.querySelector('.category-header');
            categoryHeader.style.setProperty('--category-color', category.color);
            categoryHeader.style.setProperty('--category-color-rgb', hexToRgb(category.color));

            // Charger les contenus du dossier content/{categoryId}/
            await loadCategoryContents(categoryId);

            // Gestion des favoris
            const favBtn = document.getElementById('favoriteBtn');
            if (favBtn) {
                favBtn.addEventListener('click', () => {
                    toggleFavorite('category', categoryId);
                    updateFavoriteButton();
                });
            }

            updateFavoriteButton();
        });

        // Fonction utilitaire pour convertir hex en rgb
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '59, 130, 246';
        }

        let allContents = [];
        let currentFilter = 'all';

        async function loadCategoryContents(categoryId) {
            const contentList = document.getElementById('contentList');

            try {
                // Lister les fichiers dans content/{categoryId}/
                const response = await fetch(`content/${categoryId}/index.json`);
                const data = await response.json();

                // Extraire les diffÃ©rents types de contenus
                const articles = data.articles || [];
                const tools = data.tools || [];
                const templates = data.templates || [];

                // Stocker tous les contenus avec leur type
                allContents = [
                    ...articles.map(item => ({ ...item, type: 'article' })),
                    ...tools.map(item => ({ ...item, type: 'tool' })),
                    ...templates.map(item => ({ ...item, type: 'template' }))
                ];

                if (allContents.length === 0) {
                    contentList.innerHTML = `
            <div class="empty-state">
              <p>Aucun contenu disponible pour le moment.</p>
              <a href="index.html" class="btn btn-secondary">Retour Ã  l'accueil</a>
            </div>
          `;
                    return;
                }

                // Mettre Ã  jour le compteur
                updateContentCount();

                // RÃ©cupÃ©rer la couleur de la catÃ©gorie depuis config
                const config = await fetch('config/config.json').then(r => r.json());
                const category = config.categories.find(c => c.id === categoryId);
                const categoryColor = category?.color || '#3b82f6';

                // Afficher les contenus
                renderContents(categoryId, categoryColor);

                // GÃ©rer les onglets
                setupTabs(categoryId, categoryColor);

            } catch (error) {
                console.error('Erreur chargement contenus:', error);
                contentList.innerHTML = `
          <div class="error-state">
            <p>Erreur lors du chargement des contenus.</p>
          </div>
        `;
            }
        }

        let currentView = 'list';

        function setupTabs(categoryId, categoryColor) {
            const tabs = document.querySelectorAll('.content-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Retirer la classe active de tous les onglets
                    tabs.forEach(t => t.classList.remove('active'));
                    // Ajouter la classe active Ã  l'onglet cliquÃ©
                    tab.classList.add('active');
                    
                    // Filtrer les contenus
                    currentFilter = tab.dataset.type;
                    
                    // Mettre Ã  jour l'attribut data-active-tab sur le body
                    document.body.setAttribute('data-active-tab', currentFilter);
                    
                    renderContents(categoryId, categoryColor);
                    updateContentCount();
                });
            });
            
            // Setup view switcher
            const viewBtns = document.querySelectorAll('.view-btn');
            viewBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    viewBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentView = btn.dataset.view;
                    
                    const contentList = document.getElementById('contentList');
                    contentList.setAttribute('data-view', currentView);
                    
                    renderContents(categoryId, categoryColor);
                });
            });
        }

        function updateContentCount() {
            const filtered = getFilteredContents();
            const countEl = document.getElementById('contentCount');
            
            if (currentFilter === 'all') {
                countEl.textContent = `${allContents.length} ressource${allContents.length > 1 ? 's' : ''}`;
            } else {
                const typeLabel = {
                    'articles': 'article',
                    'tools': 'outil',
                    'templates': 'template'
                }[currentFilter] || 'ressource';
                countEl.textContent = `${filtered.length} ${typeLabel}${filtered.length > 1 ? 's' : ''}`;
            }
        }

        function getFilteredContents() {
            if (currentFilter === 'all') {
                return allContents;
            }
            
            const typeMap = {
                'articles': 'article',
                'tools': 'tool',
                'templates': 'template'
            };
            
            return allContents.filter(item => item.type === typeMap[currentFilter]);
        }

        function renderContents(categoryId, categoryColor) {
            const contentList = document.getElementById('contentList');
            const filtered = getFilteredContents();

            if (filtered.length === 0) {
                const emptyMessages = {
                    'articles': {
                        title: 'Aucun article disponible',
                        message: 'Cette catÃ©gorie ne contient pas encore d\'articles. Revenez bientÃ´t !'
                    },
                    'tools': {
                        title: 'Aucun outil disponible',
                        message: 'Nous n\'avons pas encore rÃ©fÃ©rencÃ© d\'outils pour cette catÃ©gorie.'
                    },
                    'templates': {
                        title: 'Aucun template disponible',
                        message: 'Nous n\'avons pas encore de templates pour cette catÃ©gorie.'
                    }
                };
                
                const message = emptyMessages[currentFilter] || {
                    title: 'Aucun contenu disponible',
                    message: 'Cette catÃ©gorie ne contient pas encore de contenu.'
                };
                
                contentList.innerHTML = `
                    <div class="empty-state">
                        <p>${message.title}</p>
                        <span style="font-size: var(--font-size-sm); color: var(--text-secondary);">${message.message}</span>
                    </div>
                `;
                return;
            }

            // Vue liste groupÃ©e par type (sauf pour "Tout")
            if (currentView === 'list' && currentFilter !== 'all') {
                renderListView(filtered, categoryId, categoryColor);
                return;
            }
            
            // Vue grille ou vue liste pour "Tout"
            if (currentView === 'list' && currentFilter === 'all') {
                renderGroupedListView(filtered, categoryId, categoryColor);
                return;
            }

            // Vue grille par dÃ©faut
            contentList.innerHTML = filtered.map(item => {
                // DÃ©terminer le fichier Ã  utiliser (file ou id comme fallback)
                const fileName = item.file ? item.file.replace('.md', '') : item.id;
                
                const typeConfig = {
                    'article': {
                        badge: 'article',
                        icon: 'ðŸ“„',
                        linkText: 'Lire la suite',
                        url: `content.html?cat=${categoryId}&file=${fileName}`
                    },
                    'tool': {
                        badge: 'outil',
                        icon: 'ðŸ”§',
                        linkText: item.external ? 'AccÃ©der Ã  l\'outil' : 'Voir l\'outil',
                        url: item.external ? item.url : `tools/${categoryId}/${item.id}/index.html`
                    },
                    'template': {
                        badge: 'template',
                        icon: 'ðŸ“‹',
                        linkText: 'TÃ©lÃ©charger',
                        url: item.downloadUrl || `templates/${categoryId}/${item.file || item.id}`
                    }
                };

                const config = typeConfig[item.type];
                const isExternal = item.type === 'tool' && item.external;
                const isDownload = item.type === 'template';
                
                // Mapper les types vers les noms des tabs
                const dataTypeMap = {
                    'article': 'articles',
                    'tool': 'tools', 
                    'template': 'templates'
                };

                return `
                    <article class="content-card" data-type="${dataTypeMap[item.type]}" style="--category-color: ${categoryColor}; --category-color-rgb: ${hexToRgb(categoryColor)}">
                        <div class="content-card-header">
                            <span class="content-type-badge ${item.type}">${config.icon} ${config.badge}</span>
                            <h3 class="content-card-title">
                                <a href="${config.url}" ${isExternal ? 'target="_blank" rel="noopener"' : ''} ${isDownload ? 'download' : ''}>${item.title}</a>
                            </h3>
                        </div>
                        ${item.description ? `<p class="content-card-description">${item.description}</p>` : ''}
                        <div class="content-card-excerpt">
                            ${item.tags.slice(0, 4).map(tag => `<span class="content-card-tag">#${tag}</span>`).join('')}
                        </div>
                        <div class="content-card-footer">
                            ${item.type === 'article' ? '<span class="content-meta">5 min de lecture</span>' : ''}
                            ${item.type === 'tool' && item.platform ? `<span class="content-meta">${item.platform}</span>` : ''}
                            ${item.type === 'template' && item.format ? `<span class="content-meta">${item.format}</span>` : ''}
                            <a href="${config.url}" class="content-link" ${isExternal ? 'target="_blank" rel="noopener"' : ''} ${isDownload ? 'download' : ''}>
                                ${config.linkText} ${isExternal ? 'â†—' : ''}
                            </a>
                        </div>
                    </article>
                `;
            }).join('');
        }

        function renderListView(items, categoryId, categoryColor) {
            const contentList = document.getElementById('contentList');
            contentList.innerHTML = items.map(item => renderListItem(item, categoryId, categoryColor)).join('');
        }

        function renderGroupedListView(items, categoryId, categoryColor) {
            const contentList = document.getElementById('contentList');
            
            // Grouper par type
            const grouped = {
                article: items.filter(i => i.type === 'article'),
                tool: items.filter(i => i.type === 'tool'),
                template: items.filter(i => i.type === 'template')
            };
            
            const typeLabels = {
                article: { title: 'ðŸ“„ Articles', icon: 'ðŸ“„' },
                tool: { title: 'ðŸ”§ Outils', icon: 'ðŸ”§' },
                template: { title: 'ðŸ“‹ Templates', icon: 'ðŸ“‹' }
            };
            
            let html = '';
            
            Object.entries(grouped).forEach(([type, typeItems]) => {
                if (typeItems.length > 0) {
                    // Mapper les types vers les noms des tabs
                    const dataTypeMap = {
                        'article': 'articles',
                        'tool': 'tools', 
                        'template': 'templates'
                    };
                    
                    html += `
                        <div class="content-group" data-type="${dataTypeMap[type]}">
                            <h2 class="content-group-title">${typeLabels[type].title} <span class="content-group-count">(${typeItems.length})</span></h2>
                            <div class="content-group-items">
                                ${typeItems.map(item => renderListItem(item, categoryId, categoryColor)).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            contentList.innerHTML = html;
        }

        function renderListItem(item, categoryId, categoryColor) {
            // DÃ©terminer le fichier Ã  utiliser (file ou id comme fallback)
            const fileName = item.file ? item.file.replace('.md', '') : item.id;
            
            const typeConfig = {
                'article': {
                    badge: 'article',
                    icon: 'ðŸ“„',
                    linkText: 'Lire',
                    url: `content.html?cat=${categoryId}&file=${fileName}`
                },
                'tool': {
                    badge: 'outil',
                    icon: 'ðŸ”§',
                    linkText: item.external ? 'AccÃ©der' : 'Voir',
                    url: item.external ? item.url : `tools/${categoryId}/${item.id}/index.html`
                },
                'template': {
                    badge: 'template',
                    icon: 'ðŸ“‹',
                    linkText: 'TÃ©lÃ©charger',
                    url: item.downloadUrl || `templates/${categoryId}/${item.file || item.id}`
                }
            };

            const config = typeConfig[item.type];
            const isExternal = item.type === 'tool' && item.external;
            const isDownload = item.type === 'template';

            return `
                <div class="content-list-item" style="--category-color: ${categoryColor}">
                    <div class="content-list-item-main">
                        <span class="content-type-badge ${item.type}">${config.icon}</span>
                        <div class="content-list-item-content">
                            <h3 class="content-list-item-title">
                                <a href="${config.url}" ${isExternal ? 'target="_blank" rel="noopener"' : ''} ${isDownload ? 'download' : ''}>${item.title}</a>
                            </h3>
                            ${item.description ? `<p class="content-list-item-description">${item.description}</p>` : ''}
                            <div class="content-list-item-tags">
                                ${item.tags.slice(0, 5).map(tag => `<span class="content-card-tag">#${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="content-list-item-actions">
                        <a href="${config.url}" class="btn btn-secondary btn-sm" ${isExternal ? 'target="_blank" rel="noopener"' : ''} ${isDownload ? 'download' : ''}>
                            ${config.linkText} ${isExternal ? 'â†—' : ''}
                        </a>
                    </div>
                </div>
            `;
        }

        function updateFavoriteButton() {
            const urlParams = new URLSearchParams(window.location.search);
            const categoryId = urlParams.get('cat');
            const favorites = JSON.parse(localStorage.getItem('favorites') || '{"categories":[],"tools":[]}');
            const isFavorite = favorites.categories.includes(categoryId);

            const btn = document.getElementById('favoriteBtn');
            const svg = btn.querySelector('svg');

            if (isFavorite) {
                svg.setAttribute('fill', 'currentColor');
                btn.classList.add('active');
            } else {
                svg.setAttribute('fill', 'none');
                btn.classList.remove('active');
            }
        }
    </script>
</body>

</html>