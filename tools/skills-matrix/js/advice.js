/**
 * Skills Matrix - Syst√®me de conseils automatis√©s
 */

// Base de connaissances des conseils (style Coach Sticko)
const adviceDatabase = {
    1: { // D√©butant
        emoji: 'üå±',
        messages: [
            "Pas de panique ! Tout le monde commence quelque part. Voici comment d√©marrer en douceur.",
            "C'est le moment parfait pour apprendre ! Commence par les bases et tu verras, √ßa va vite.",
            "D√©butant aujourd'hui, expert demain ! Voici ton plan d'action pour progresser.",
            "Super que tu veuilles apprendre ! Voici des ressources pour bien d√©marrer."
        ],
        resources: [
            { icon: 'üì∫', text: 'Tutoriels vid√©o pour d√©butants', type: 'video' },
            { icon: 'üìñ', text: 'Documentation officielle - Getting Started', type: 'doc' },
            { icon: 'üë•', text: 'Trouver un mentor dans l\'√©quipe', type: 'mentor' },
            { icon: 'üí™', text: 'Exercices pratiques niveau d√©butant', type: 'practice' }
        ],
        actionPlan: "Commence par regarder des tutoriels, puis pratique avec des exercices simples. N'h√©site pas √† demander de l'aide !"
    },
    2: { // Apprentissage
        emoji: 'üöÄ',
        messages: [
            "Tu progresses bien ! Continue comme √ßa, tu es sur la bonne voie.",
            "Bravo pour tes efforts ! Voici comment passer au niveau sup√©rieur.",
            "Tu as les bases, maintenant il est temps de pratiquer davantage.",
            "Super progression ! Voici des ressources pour consolider tes acquis."
        ],
        resources: [
            { icon: 'üéØ', text: 'Projets pratiques interm√©diaires', type: 'practice' },
            { icon: 'üìö', text: 'Cours avanc√©s et best practices', type: 'course' },
            { icon: 'üë•', text: 'Pair programming avec un expert', type: 'mentor' },
            { icon: 'üîß', text: 'Challenges et exercices', type: 'challenge' }
        ],
        actionPlan: "Pratique r√©guli√®rement avec des projets concrets. Travaille avec des coll√®gues plus exp√©riment√©s pour apprendre leurs techniques."
    },
    3: { // Comp√©tent
        emoji: '‚≠ê',
        messages: [
            "Excellent niveau ! Tu peux maintenant aider les autres √† progresser.",
            "Tu ma√Ætrises bien le sujet ! Pense √† partager ton savoir avec l'√©quipe.",
            "Bravo ! Tu es autonome. Pourquoi ne pas viser l'expertise ?",
            "Super ! Tu peux maintenant te lancer dans des projets complexes."
        ],
        resources: [
            { icon: 'üéì', text: 'Formations avanc√©es et certifications', type: 'certification' },
            { icon: 'üìù', text: 'R√©diger de la documentation', type: 'doc' },
            { icon: 'üë®‚Äçüè´', text: 'Devenir mentor pour les juniors', type: 'mentor' },
            { icon: 'üöÄ', text: 'Projets innovants et R&D', type: 'innovation' }
        ],
        actionPlan: "Partage tes connaissances en mentorant d'autres membres. Explore des sujets avanc√©s pour devenir expert."
    },
    4: { // Expert
        emoji: 'üèÜ',
        messages: [
            "Expert reconnu ! Tu es une ressource pr√©cieuse pour l'√©quipe.",
            "Ma√Ætrise totale ! Continue √† innover et √† partager ton expertise.",
            "Bravo ! Tu es la r√©f√©rence sur ce sujet dans l'√©quipe.",
            "Excellence ! Pense √† documenter tes connaissances pour l'√©quipe."
        ],
        resources: [
            { icon: 'üì¢', text: 'Conf√©rences et pr√©sentations', type: 'speaking' },
            { icon: '‚úçÔ∏è', text: 'Articles techniques et blog posts', type: 'writing' },
            { icon: 'üéØ', text: 'Veille technologique et innovation', type: 'innovation' },
            { icon: 'üë•', text: 'Mentorat et formation d\'√©quipe', type: 'mentor' }
        ],
        actionPlan: "Partage ton expertise via des pr√©sentations, articles ou formations. Reste √† jour avec les derni√®res innovations."
    }
};

/**
 * G√©n√©rer la liste des conseils
 */
function generateAdviceList() {
    const memberAdviceMap = {};

    // Filtrer selon visibleMembers
    const membersToProcess = visibleMembers.length > 0
        ? matrixData.members.filter((_, idx) => visibleMembers.includes(idx))
        : matrixData.members;

    membersToProcess.forEach((member) => {
        const memberIndex = matrixData.members.indexOf(member);
        const memberSkills = [];

        member.levels.forEach((level, skillIndex) => {
            // G√©n√©rer des conseils pour les niveaux 1, 2, 3 (pas pour 0 ni 4)
            if (level >= 1 && level <= 3) {
                memberSkills.push({
                    skill: matrixData.skills[skillIndex],
                    level: level,
                    skillIndex: skillIndex
                });
            }
        });

        if (memberSkills.length > 0) {
            memberAdviceMap[member.name] = {
                member: member.name,
                memberIndex: memberIndex,
                skills: memberSkills
            };
        }
    });

    return Object.values(memberAdviceMap);
}

/**
 * Mode d'affichage des conseils (par d√©faut: par membre)
 */
let adviceViewMode = 'member'; // 'member' ou 'skill'

/**
 * Rendre les conseils
 */
function renderAdvice() {
    const adviceCards = document.getElementById('adviceCards');
    if (!adviceCards) return;

    adviceCards.innerHTML = '';

    const adviceList = generateAdviceList();

    if (adviceList.length === 0) {
        adviceCards.innerHTML = `
            <div class="no-advice">
                <div style="font-size: 3em; margin-bottom: 20px;">üéâ</div>
                <p>Aucun conseil pour le moment !</p>
                <p style="font-size: 0.9em; margin-top: 10px;">Ajoutez des membres et √©valuez leurs comp√©tences pour recevoir des conseils personnalis√©s.</p>
            </div>
        `;
        return;
    }

    if (adviceViewMode === 'member') {
        renderAdviceByMember(adviceList, adviceCards);
    } else {
        renderAdviceBySkill(adviceList, adviceCards);
    }
}

/**
 * Rendre les conseils par membre (mode par d√©faut)
 */
function renderAdviceByMember(adviceList, container) {
    adviceList.forEach(memberAdvice => {
        const card = createMemberAdviceCard(memberAdvice);
        container.appendChild(card);
    });
}

/**
 * Rendre les conseils par comp√©tence
 */
function renderAdviceBySkill(adviceList, container) {
    // Regrouper par comp√©tence
    const skillMap = {};

    adviceList.forEach(memberAdvice => {
        memberAdvice.skills.forEach(skillData => {
            if (!skillMap[skillData.skill]) {
                skillMap[skillData.skill] = [];
            }
            skillMap[skillData.skill].push({
                member: memberAdvice.member,
                memberIndex: memberAdvice.memberIndex,
                level: skillData.level,
                skillIndex: skillData.skillIndex
            });
        });
    });

    // Cr√©er une carte par comp√©tence
    Object.keys(skillMap).sort().forEach(skillName => {
        const card = createSkillAdviceCard(skillName, skillMap[skillName]);
        container.appendChild(card);
    });
}

/**
 * Trouver des mentors pour une app√©tence
 */
function findMentorsForAppetence(appetenceName, currentMemberName) {
    const mentors = [];

    matrixData.members.forEach(member => {
        // Ne pas sugg√©rer le membre lui-m√™me
        if (member.name === currentMemberName) return;

        // V√©rifier si le membre a cette comp√©tence (skill)
        const skillIndex = matrixData.skills.indexOf(appetenceName);
        if (skillIndex !== -1 && member.levels[skillIndex] >= 3) {
            mentors.push({
                name: member.name,
                type: 'skill',
                level: member.levels[skillIndex]
            });
        }

        // V√©rifier si le membre a un ownership sur ce sujet
        if (member.ownerships && member.ownerships.some(own => own.toLowerCase().includes(appetenceName.toLowerCase()))) {
            mentors.push({
                name: member.name,
                type: 'ownership',
                level: 4 // Ownership = expertise
            });
        }
    });

    // Trier par niveau (les plus experts en premier)
    return mentors.sort((a, b) => b.level - a.level);
}

/**
 * Cr√©er une carte de conseil par membre (regroupe toutes les comp√©tences)
 */
function createMemberAdviceCard(memberAdvice) {
    const card = document.createElement('div');
    card.className = 'advice-card member-card';

    const member = matrixData.members.find(m => m.name === memberAdvice.member);
    const hasAppetences = member?.appetences && member.appetences.length > 0;
    const hasOwnerships = member?.ownerships && member.ownerships.length > 0;

    // Trouver des mentors pour les app√©tences
    const appetenceMentors = {};
    if (hasAppetences) {
        member.appetences.forEach(appetence => {
            const mentorsForAppetence = findMentorsForAppetence(appetence, memberAdvice.member);
            if (mentorsForAppetence.length > 0) {
                appetenceMentors[appetence] = mentorsForAppetence;
            }
        });
    }

    // G√©n√©rer la liste des comp√©tences √† d√©velopper
    const skillsList = memberAdvice.skills.map(skillData => {
        const adviceData = adviceDatabase[skillData.level];
        return `
            <div class="skill-item level-${skillData.level}">
                <span class="skill-emoji">${adviceData.emoji}</span>
                <span class="skill-name">${skillData.skill}</span>
                <span class="skill-level">Niveau ${skillData.level}/4</span>
            </div>
        `;
    }).join('');

    // Sections App√©tences et Ownerships
    let appetencesSection = '';
    if (hasAppetences) {
        const appetencesWithMentors = member.appetences.map(app => {
            const mentors = appetenceMentors[app] || [];
            return { name: app, mentors };
        });

        appetencesSection = `
            <div class="advice-appetences-section">
                <h4 class="advice-appetences-title">
                    üéØ App√©tences
                </h4>
                <div class="advice-appetences-list">
                    ${appetencesWithMentors.map(({ name, mentors }) => `
                        <div class="advice-appetence-item">
                            <div class="advice-appetence-header">
                                <span class="advice-appetence-badge">${name}</span>
                                ${mentors.length > 0 ? `
                                    <span class="advice-appetence-mentors-label">‚Üí Mentors</span>
                                ` : ''}
                            </div>
                            ${mentors.length > 0 ? `
                                <div class="advice-mentors-list">
                                    ${mentors.slice(0, 3).map(mentor => `
                                        <span class="advice-mentor-badge">
                                            ${mentor.type === 'ownership' ? 'üèÜ' : '‚≠ê'} ${mentor.name}
                                        </span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    let ownershipsSection = '';
    if (hasOwnerships) {
        ownershipsSection = `
            <div class="advice-ownerships-section">
                <h4 class="advice-ownerships-title">
                    üèÜ Responsabilit√©s
                </h4>
                <div class="advice-ownerships-list">
                    ${member.ownerships.map(own => `
                        <span class="advice-ownership-badge">${own}</span>
                    `).join('')}
                </div>
            </div>
        `;
    }

    card.innerHTML = `
        <div class="advice-header">
            <span class="advice-emoji">üë§</span>
            <div>
                <div class="advice-title">${memberAdvice.member}</div>
                <div class="advice-member">${memberAdvice.skills.length} comp√©tence(s) √† d√©velopper</div>
            </div>
        </div>

        <div class="advice-skills-list">
            <h4>üéØ Comp√©tences √† d√©velopper</h4>
            ${skillsList}
        </div>

        ${appetencesSection}
        ${ownershipsSection}

        <div class="advice-message">
            üí° Continue √† progresser sur ces comp√©tences pour atteindre l'autonomie compl√®te !
        </div>
    `;

    return card;
}

/**
 * Cr√©er une carte de conseil par comp√©tence (regroupe tous les membres)
 */
function createSkillAdviceCard(skillName, members) {
    const card = document.createElement('div');
    card.className = 'advice-card skill-card';

    // Regrouper par niveau
    const byLevel = {
        1: members.filter(m => m.level === 1),
        2: members.filter(m => m.level === 2),
        3: members.filter(m => m.level === 3)
    };

    // G√©n√©rer la liste des membres par niveau
    const membersList = Object.keys(byLevel).map(level => {
        if (byLevel[level].length === 0) return '';

        const adviceData = adviceDatabase[level];
        return `
            <div class="level-group level-${level}">
                <div class="level-group-header">
                    <span class="level-emoji">${adviceData.emoji}</span>
                    <span class="level-title">Niveau ${level}/4</span>
                    <span class="level-count">${byLevel[level].length} membre(s)</span>
                </div>
                <div class="level-members">
                    ${byLevel[level].map(m => `
                        <span class="member-badge">${m.member}</span>
                    `).join('')}
                </div>
            </div>
        `;
    }).filter(html => html).join('');

    // Trouver les experts (niveau 4)
    const experts = matrixData.members.filter(member => {
        const skillIndex = matrixData.skills.indexOf(skillName);
        return skillIndex !== -1 && member.levels[skillIndex] === 4;
    });

    let expertsSection = '';
    if (experts.length > 0) {
        expertsSection = `
            <div class="advice-experts-section">
                <h4 class="advice-experts-title">
                    üèÜ Experts disponibles
                </h4>
                <div class="advice-experts-list">
                    ${experts.map(expert => `
                        <span class="advice-expert-badge">${expert.name}</span>
                    `).join('')}
                </div>
                <p class="advice-experts-note">
                    Ces membres peuvent aider √† progresser sur cette comp√©tence.
                </p>
            </div>
        `;
    }

    card.innerHTML = `
        <div class="advice-header">
            <span class="advice-emoji">üéØ</span>
            <div>
                <div class="advice-title">${skillName}</div>
                <div class="advice-member">${members.length} membre(s) en progression</div>
            </div>
        </div>

        <div class="advice-members-by-level">
            ${membersList}
        </div>

        ${expertsSection}

        <div class="advice-message">
            üí° Organisez des sessions de partage de connaissances pour faire progresser toute l'√©quipe !
        </div>
    `;

    return card;
}

/**
 * Cr√©er une carte de conseil (ancienne version - conserv√©e pour compatibilit√©)
 */
function createAdviceCard(memberName, skillData) {
    const card = document.createElement('div');
    card.className = `advice-card level-${skillData.level}`;

    const adviceData = adviceDatabase[skillData.level];
    const message = adviceData.messages[Math.floor(Math.random() * adviceData.messages.length)];

    // Trouver des mentors potentiels
    const mentors = findMentors(skillData.skillIndex, skillData.level);
    const mentorSuggestions = mentors.length > 0 ? mentors.map(m => m.name) : [];

    // R√©cup√©rer les infos du membre
    const member = matrixData.members.find(m => m.name === memberName);
    const hasAppetences = member?.appetences && member.appetences.length > 0;
    const hasOwnerships = member?.ownerships && member.ownerships.length > 0;

    // Trouver des mentors pour les app√©tences
    const appetenceMentors = {};
    if (hasAppetences) {
        member.appetences.forEach(appetence => {
            const mentorsForAppetence = findMentorsForAppetence(appetence, memberName);
            if (mentorsForAppetence.length > 0) {
                appetenceMentors[appetence] = mentorsForAppetence;
            }
        });
    }

    const skillsList = `<strong>${skillData.skill}</strong> (Niveau ${skillData.level}/4)`;

    // G√©n√©rer les sections suppl√©mentaires
    let appetencesSection = '';
    if (hasAppetences) {
        const appetencesWithMentors = member.appetences.map(app => {
            const mentors = appetenceMentors[app] || [];
            return { name: app, mentors };
        });

        appetencesSection = `
            <div class="advice-appetences-section">
                <h4 class="advice-appetences-title">
                    üéØ App√©tences de ${memberName}
                </h4>
                <div class="advice-appetences-list">
                    ${appetencesWithMentors.map(({ name, mentors }) => `
                        <div class="advice-appetence-item">
                            <div class="advice-appetence-header">
                                <span class="advice-appetence-badge">${name}</span>
                                ${mentors.length > 0 ? `
                                    <span class="advice-appetence-mentors-label">‚Üí Mentors disponibles</span>
                                ` : ''}
                            </div>
                            ${mentors.length > 0 ? `
                                <div class="advice-mentors-list">
                                    ${mentors.map(mentor => `
                                        <span class="advice-mentor-badge">
                                            ${mentor.type === 'ownership' ? 'üèÜ' : '‚≠ê'} ${mentor.name}
                                        </span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
                <p class="advice-appetences-note">
                    üí° Ces sujets int√©ressent ${memberName}. ${Object.keys(appetenceMentors).length > 0 ? 'Contacte les mentors sugg√©r√©s pour progresser !' : 'Pense √† les int√©grer dans ton plan de d√©veloppement !'}
                </p>
            </div>
        `;
    }

    let ownershipsSection = '';
    if (hasOwnerships) {
        ownershipsSection = `
            <div class="advice-ownerships-section">
                <h4 class="advice-ownerships-title">
                    üèÜ Responsabilit√©s de ${memberName}
                </h4>
                <div class="advice-ownerships-list">
                    ${member.ownerships.map(own => `
                        <span class="advice-ownership-badge">${own}</span>
                    `).join('')}
                </div>
                <p class="advice-ownerships-note">
                    üí™ ${memberName} est responsable de ces sujets. D√©velopper cette comp√©tence renforcera son expertise !
                </p>
            </div>
        `;
    }

    card.innerHTML = `
        <div class="advice-header">
            <span class="advice-emoji">${adviceData.emoji}</span>
            <div>
                <div class="advice-title">Conseil pour ${memberName}</div>
                <div class="advice-member">${skillsList}</div>
            </div>
        </div>

        <div class="advice-message">
            ${message}
        </div>

        <div class="advice-skill-section">
            <h4 class="advice-skill-title">üéØ Comp√©tence √† d√©velopper</h4>
            ${skillsList}
        </div>

        ${appetencesSection}
        ${ownershipsSection}

        <div class="advice-resources">
            <h4>üìö Ressources recommand√©es</h4>
            ${adviceData.resources.map(resource => `
                <div class="resource-item" onclick="handleResourceClick('${resource.type}', '${resource.text}')">
                    <span class="resource-icon">${resource.icon}</span>
                    <span class="resource-text">${resource.text}</span>
                </div>
            `).join('')}
            ${mentorSuggestions.length > 0 ? `
                <div class="resource-item" onclick="handleResourceClick('mentor', 'Mentors sugg√©r√©s')">
                    <span class="resource-icon">üë•</span>
                    <span class="resource-text">Mentors sugg√©r√©s : ${mentorSuggestions.join(', ')}</span>
                </div>
            ` : ''}
        </div>

        <div class="action-plan">
            <h4>üìã Plan d'action</h4>
            <p>${adviceData.actionPlan}</p>
        </div>
    `;

    return card;
}

/**
 * Trouver des mentors potentiels
 */
function findMentors(skillIndex, currentLevel) {
    return matrixData.members.filter(member => {
        const memberLevel = member.levels[skillIndex] || 0;
        return memberLevel >= 3 && memberLevel > currentLevel;
    });
}

/**
 * G√©rer le clic sur une ressource
 */
function handleResourceClick(type, text) {
    console.log(`Ressource cliqu√©e: ${type} - ${text}`);
    // Ici vous pouvez ajouter une logique pour ouvrir des liens, etc.
}

/**
 * Changer le mode d'affichage des conseils
 */
function switchAdviceView(mode, targetButton) {
    adviceViewMode = mode;

    // Mettre √† jour les boutons de vue
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    if (targetButton) {
        targetButton.classList.add('active');
    }

    // R√©initialiser le filtre √† "Tous"
    activeAdviceFilter = 'all';
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector('.filter-btn[onclick*="all"]')?.classList.add('active');

    // Re-rendre les conseils
    renderAdvice();
}

/**
 * Filtrer les conseils
 */
function filterAdvice(filter, targetButton) {
    activeAdviceFilter = filter;

    // Mettre √† jour les boutons de filtre
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    if (targetButton) {
        targetButton.classList.add('active');
    }

    // Filtrer les cartes selon le mode
    const cards = document.querySelectorAll('.advice-card');

    if (adviceViewMode === 'member') {
        // En mode membre, afficher/masquer les cartes enti√®res
        cards.forEach(card => {
            card.style.display = filter === 'all' ? 'block' : 'none';
        });
    } else {
        // En mode comp√©tence, filtrer les groupes de niveau
        cards.forEach(card => {
            const levelGroups = card.querySelectorAll('.level-group');
            let hasVisibleGroups = false;

            levelGroups.forEach(group => {
                const level = parseInt(group.className.match(/level-(\d)/)[1]);
                let show = false;

                switch (filter) {
                    case 'all':
                        show = true;
                        break;
                    case 'beginner':
                        show = level === 1;
                        break;
                    case 'learning':
                        show = level === 2;
                        break;
                    case 'competent':
                        show = level === 3;
                        break;
                }

                group.style.display = show ? 'block' : 'none';
                if (show) hasVisibleGroups = true;
            });

            // Masquer la carte si aucun groupe n'est visible
            card.style.display = hasVisibleGroups ? 'block' : 'none';
        });
    }
}

/**
 * Mettre √† jour toutes les vues de conseils
 */
function updateAllAdviceViews() {
    renderAdvice();
    if (typeof renderStrategicAdvice === 'function') {
        renderStrategicAdvice();
    }
}

/**
 * Exporter les conseils en Markdown
 */
function exportAdviceToMarkdown() {
    try {
        showControlsLoader('üìù Export Markdown...');

        setTimeout(() => {
            let markdown = `# üí° Conseils Personnalis√©s - Coach Sticko\n\n`;
            markdown += `*G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}*\n\n`;
            markdown += `---\n\n`;

            // G√©n√©rer la liste des conseils
            const memberAdviceMap = {};
            const membersToProcess = visibleMembers.length > 0
                ? matrixData.members.filter((_, idx) => visibleMembers.includes(idx))
                : matrixData.members;

            membersToProcess.forEach((member) => {
                const memberSkills = [];
                member.levels.forEach((level, skillIndex) => {
                    if (level >= 1 && level <= 3) {
                        memberSkills.push({
                            skill: matrixData.skills[skillIndex],
                            level: level
                        });
                    }
                });

                if (memberSkills.length > 0) {
                    memberAdviceMap[member.name] = {
                        member: member,
                        skills: memberSkills
                    };
                }
            });

            // Trier par nombre de comp√©tences √† am√©liorer
            const sortedMembers = Object.entries(memberAdviceMap)
                .sort((a, b) => b[1].skills.length - a[1].skills.length);

            // Calculer les statistiques pour le sommaire
            const totalMembers = sortedMembers.length;
            const totalSkillsToImprove = sortedMembers.reduce((sum, [_, data]) => sum + data.skills.length, 0);

            // Compter les comp√©tences uniques
            const uniqueSkills = new Set();
            sortedMembers.forEach(([_, data]) => {
                data.skills.forEach(skill => uniqueSkills.add(skill.skill));
            });

            // Calculer les conseils strat√©giques
            let strategicAdvice = null;
            let risksCount = 0;
            let mentoringCount = 0;
            let workloadCount = 0;

            if (typeof generateStrategicAdvice === 'function') {
                strategicAdvice = generateStrategicAdvice();
                risksCount = strategicAdvice.risks ? strategicAdvice.risks.length : 0;
                mentoringCount = strategicAdvice.mentoring ? strategicAdvice.mentoring.length : 0;
                workloadCount = strategicAdvice.workload ? strategicAdvice.workload.length : 0;
            }

            // G√©n√©rer le sommaire
            markdown += `## üìã Sommaire\n\n`;
            markdown += `### üìä Vue d'ensemble\n\n`;
            markdown += `- **${totalMembers}** membre${totalMembers > 1 ? 's' : ''} √† accompagner\n`;
            markdown += `- **${totalSkillsToImprove}** comp√©tence${totalSkillsToImprove > 1 ? 's' : ''} √† d√©velopper (total)\n`;
            markdown += `- **${uniqueSkills.size}** comp√©tence${uniqueSkills.size > 1 ? 's' : ''} unique${uniqueSkills.size > 1 ? 's' : ''} concern√©e${uniqueSkills.size > 1 ? 's' : ''}\n`;

            if (strategicAdvice) {
                markdown += `- **${risksCount}** risque${risksCount > 1 ? 's' : ''} de comp√©tence identifi√©${risksCount > 1 ? 's' : ''}\n`;
                markdown += `- **${mentoringCount}** opportunit√©${mentoringCount > 1 ? 's' : ''} de mentorat\n`;
            }
            markdown += `\n`;

            markdown += `### üìë Sections du rapport\n\n`;
            markdown += `1. [üí° Conseils par Membre](#-conseils-par-membre)\n`;
            markdown += `   - Conseils personnalis√©s pour chaque membre\n`;
            markdown += `   - Plans d'action et ressources recommand√©es\n`;
            markdown += `\n`;
            markdown += `2. [üéØ Conseils par Comp√©tence](#-conseils-par-comp√©tence)\n`;
            markdown += `   - Vue globale par comp√©tence\n`;
            markdown += `   - Identification des experts disponibles\n`;
            markdown += `   - R√©partition par niveau (D√©butant, Apprentissage, Comp√©tent)\n`;
            markdown += `\n`;
            markdown += `3. [üìä Conseils Strat√©giques d'√âquipe](#-conseils-strat√©giques-d√©quipe)\n`;

            if (risksCount > 0) {
                markdown += `   - [‚ö†Ô∏è Risques de Comp√©tences](#Ô∏è-risques-de-comp√©tences) (${risksCount})\n`;
            }
            if (mentoringCount > 0) {
                markdown += `   - [üë• Opportunit√©s de Mentorat](#-opportunit√©s-de-mentorat) (${mentoringCount})\n`;
            }
            if (workloadCount > 0) {
                markdown += `   - [‚öñÔ∏è √âquilibrage de Charge](#Ô∏è-√©quilibrage-de-charge) (${workloadCount} membres)\n`;
            }
            markdown += `\n`;

            markdown += `---\n\n`;

            // Section 1: Conseils par membre
            markdown += `# üí° Conseils par Membre\n\n`;

            // G√©n√©rer le markdown par membre
            sortedMembers.forEach(([memberName, data]) => {
                markdown += `## üë§ ${memberName}\n\n`;

                // Grouper par niveau
                const skillsByLevel = {
                    1: [],
                    2: [],
                    3: []
                };

                data.skills.forEach(skill => {
                    skillsByLevel[skill.level].push(skill.skill);
                });

                // Niveau 1 - D√©butant
                if (skillsByLevel[1].length > 0) {
                    const advice = adviceDatabase[1];
                    markdown += `### ${advice.emoji} D√©butant (${skillsByLevel[1].length} comp√©tence${skillsByLevel[1].length > 1 ? 's' : ''})\n\n`;
                    markdown += `**Comp√©tences :** ${skillsByLevel[1].join(', ')}\n\n`;
                    markdown += `**Message :** ${advice.messages[0]}\n\n`;
                    markdown += `**Plan d'action :** ${advice.actionPlan}\n\n`;
                    markdown += `**Ressources recommand√©es :**\n`;
                    advice.resources.forEach(resource => {
                        markdown += `- ${resource.icon} ${resource.text}\n`;
                    });
                    markdown += `\n`;
                }

                // Niveau 2 - Apprentissage
                if (skillsByLevel[2].length > 0) {
                    const advice = adviceDatabase[2];
                    markdown += `### ${advice.emoji} En apprentissage (${skillsByLevel[2].length} comp√©tence${skillsByLevel[2].length > 1 ? 's' : ''})\n\n`;
                    markdown += `**Comp√©tences :** ${skillsByLevel[2].join(', ')}\n\n`;
                    markdown += `**Message :** ${advice.messages[0]}\n\n`;
                    markdown += `**Plan d'action :** ${advice.actionPlan}\n\n`;
                    markdown += `**Ressources recommand√©es :**\n`;
                    advice.resources.forEach(resource => {
                        markdown += `- ${resource.icon} ${resource.text}\n`;
                    });
                    markdown += `\n`;
                }

                // Niveau 3 - Comp√©tent
                if (skillsByLevel[3].length > 0) {
                    const advice = adviceDatabase[3];
                    markdown += `### ${advice.emoji} Comp√©tent (${skillsByLevel[3].length} comp√©tence${skillsByLevel[3].length > 1 ? 's' : ''})\n\n`;
                    markdown += `**Comp√©tences :** ${skillsByLevel[3].join(', ')}\n\n`;
                    markdown += `**Message :** ${advice.messages[0]}\n\n`;
                    markdown += `**Plan d'action :** ${advice.actionPlan}\n\n`;
                    markdown += `**Ressources recommand√©es :**\n`;
                    advice.resources.forEach(resource => {
                        markdown += `- ${resource.icon} ${resource.text}\n`;
                    });
                    markdown += `\n`;
                }

                markdown += `---\n\n`;
            });

            // Ajouter les conseils par comp√©tences
            markdown += `# üéØ Conseils par Comp√©tence\n\n`;

            // Regrouper par comp√©tence
            const skillMap = {};
            sortedMembers.forEach(([memberName, data]) => {
                data.skills.forEach(skillData => {
                    if (!skillMap[skillData.skill]) {
                        skillMap[skillData.skill] = [];
                    }
                    skillMap[skillData.skill].push({
                        member: memberName,
                        level: skillData.level
                    });
                });
            });

            // Trier les comp√©tences par nombre de personnes √† former
            const sortedSkills = Object.entries(skillMap)
                .sort((a, b) => b[1].length - a[1].length);

            sortedSkills.forEach(([skillName, members]) => {
                markdown += `## üéØ ${skillName}\n\n`;
                markdown += `**${members.length} personne${members.length > 1 ? 's' : ''} √† accompagner**\n\n`;

                // Grouper par niveau
                const byLevel = {
                    1: [],
                    2: [],
                    3: []
                };

                members.forEach(m => {
                    byLevel[m.level].push(m.member);
                });

                // D√©butants
                if (byLevel[1].length > 0) {
                    markdown += `### üå± D√©butants (${byLevel[1].length})\n`;
                    byLevel[1].forEach(name => {
                        markdown += `- ${name}\n`;
                    });
                    markdown += `\n`;
                }

                // En apprentissage
                if (byLevel[2].length > 0) {
                    markdown += `### üöÄ En apprentissage (${byLevel[2].length})\n`;
                    byLevel[2].forEach(name => {
                        markdown += `- ${name}\n`;
                    });
                    markdown += `\n`;
                }

                // Comp√©tents
                if (byLevel[3].length > 0) {
                    markdown += `### ‚≠ê Comp√©tents (${byLevel[3].length})\n`;
                    byLevel[3].forEach(name => {
                        markdown += `- ${name}\n`;
                    });
                    markdown += `\n`;
                }

                // Trouver les experts disponibles pour mentorat
                const experts = matrixData.members.filter(m => {
                    const skillIndex = matrixData.skills.indexOf(skillName);
                    return skillIndex !== -1 && m.levels[skillIndex] === 4;
                });

                if (experts.length > 0) {
                    markdown += `**üë®‚Äçüè´ Experts disponibles pour mentorat :** ${experts.map(e => e.name).join(', ')}\n\n`;
                } else {
                    markdown += `**‚ö†Ô∏è Aucun expert disponible** - Envisager une formation externe\n\n`;
                }

                markdown += `---\n\n`;
            });

            // Ajouter les conseils strat√©giques si disponibles
            if (typeof generateStrategicAdvice === 'function') {
                const strategicAdvice = generateStrategicAdvice();

                markdown += `# üìä Conseils Strat√©giques d'√âquipe\n\n`;

                // Risques de comp√©tences
                if (strategicAdvice.risks && strategicAdvice.risks.length > 0) {
                    markdown += `## ‚ö†Ô∏è Risques de Comp√©tences\n\n`;
                    markdown += `*Comp√©tences avec peu ou pas d'experts - Risque de perte de connaissance*\n\n`;

                    strategicAdvice.risks.forEach(risk => {
                        const riskIcon = risk.riskLevel === 'critical' ? 'üî¥' : 'üü†';
                        const riskLabel = risk.riskLevel === 'critical' ? 'CRITIQUE' : '√âLEV√â';

                        markdown += `### ${riskIcon} ${risk.skill} - Risque ${riskLabel}\n\n`;

                        if (risk.experts.length === 0) {
                            markdown += `**‚ö†Ô∏è AUCUN EXPERT** - Risque de perte de comp√©tence critique\n\n`;
                        } else {
                            markdown += `**Expert unique :** ${risk.experts[0].name}\n\n`;
                        }

                        if (risk.backup.length > 0) {
                            markdown += `**Personnes en backup :**\n`;
                            risk.backup.forEach(member => {
                                const skillIndex = risk.skillIndex;
                                const level = member.levels[skillIndex];
                                const levelLabel = level === 3 ? 'Comp√©tent' : level === 2 ? 'En apprentissage' : 'D√©butant';
                                markdown += `- ${member.name} (${levelLabel})\n`;
                            });
                            markdown += `\n`;
                        }

                        markdown += `**Actions recommand√©es :**\n`;
                        if (risk.experts.length === 0) {
                            markdown += `- üö® Formation externe urgente\n`;
                            markdown += `- üìö Documentation de la comp√©tence\n`;
                            markdown += `- üîç Recrutement d'un expert\n`;
                        } else {
                            markdown += `- üë• Organiser des sessions de partage de connaissances\n`;
                            markdown += `- üìù Documenter les pratiques et processus\n`;
                            markdown += `- üéØ Former ${risk.backup.length} personne${risk.backup.length > 1 ? 's' : ''} en backup\n`;
                        }
                        markdown += `\n---\n\n`;
                    });
                }

                // Opportunit√©s de mentorat
                if (strategicAdvice.mentoring && strategicAdvice.mentoring.length > 0) {
                    markdown += `## üë• Opportunit√©s de Mentorat\n\n`;
                    markdown += `*Paires mentor/mentor√© recommand√©es pour acc√©l√©rer la mont√©e en comp√©tence*\n\n`;

                    // Grouper par comp√©tence
                    const mentoringBySkill = {};
                    strategicAdvice.mentoring.forEach(opp => {
                        if (!mentoringBySkill[opp.skill]) {
                            mentoringBySkill[opp.skill] = [];
                        }
                        mentoringBySkill[opp.skill].push(opp);
                    });

                    Object.entries(mentoringBySkill).forEach(([skill, opportunities]) => {
                        markdown += `### üéØ ${skill}\n\n`;

                        opportunities.forEach(opp => {
                            const priorityIcon = opp.hasAppetence ? '‚≠ê' : 'üìå';
                            const priorityLabel = opp.hasAppetence ? 'PRIORITAIRE (App√©tence)' : 'Recommand√©';

                            markdown += `**${priorityIcon} ${priorityLabel}**\n`;
                            markdown += `- **mentor√© :** ${opp.mentor√©.name} (Niveau ${opp.mentor√©Level})\n`;
                            markdown += `- **Mentors disponibles :** ${opp.mentors.map(m => m.name).join(', ')}\n`;

                            if (opp.hasAppetence) {
                                markdown += `- **üí° Motivation √©lev√©e** - Cette personne a exprim√© une app√©tence pour cette comp√©tence\n`;
                            }

                            markdown += `\n`;
                        });

                        markdown += `---\n\n`;
                    });
                }

                // √âquilibrage de charge
                if (strategicAdvice.workload && strategicAdvice.workload.length > 0) {
                    markdown += `## ‚öñÔ∏è √âquilibrage de Charge\n\n`;
                    markdown += `*Analyse de la r√©partition des expertises et responsabilit√©s*\n\n`;

                    // Trier par charge (expertises + ownerships)
                    const sortedWorkload = strategicAdvice.workload
                        .sort((a, b) => (b.expertiseCount + b.ownershipsCount) - (a.expertiseCount + a.ownershipsCount));

                    sortedWorkload.forEach(workload => {
                        const totalLoad = workload.expertiseCount + workload.ownershipsCount;
                        const loadIcon = totalLoad > 8 ? 'üî¥' : totalLoad > 5 ? 'üü°' : 'üü¢';
                        const loadLabel = totalLoad > 8 ? 'Charge √©lev√©e' : totalLoad > 5 ? 'Charge moyenne' : 'Charge normale';

                        markdown += `### ${loadIcon} ${workload.member.name} - ${loadLabel}\n\n`;
                        markdown += `- **Expertises (niveau 4) :** ${workload.expertiseCount}\n`;
                        markdown += `- **Ownerships :** ${workload.ownershipsCount}\n`;
                        markdown += `- **Total :** ${totalLoad}\n\n`;

                        if (totalLoad > 8) {
                            markdown += `**‚ö†Ô∏è Recommandations :**\n`;
                            markdown += `- D√©l√©guer certaines responsabilit√©s\n`;
                            markdown += `- Former des backup sur les expertises critiques\n`;
                            markdown += `- √âviter de surcharger avec de nouvelles responsabilit√©s\n\n`;
                        } else if (totalLoad < 3) {
                            markdown += `**üí° Opportunit√©s :**\n`;
                            markdown += `- Peut prendre de nouvelles responsabilit√©s\n`;
                            markdown += `- Candidat id√©al pour d√©velopper de nouvelles expertises\n\n`;
                        }

                        markdown += `---\n\n`;
                    });
                }
            }

            // T√©l√©charger le fichier
            const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `conseils-skills-matrix-${getFormattedDate()}.md`;
            link.click();
            URL.revokeObjectURL(url);

            hideControlsLoader();
            showNotification('üìù Export Markdown r√©ussi', 'success');
        }, 100);
    } catch (error) {
        hideControlsLoader();
        console.error('‚ùå Erreur lors de l\'export Markdown:', error);
        showNotification('‚ö†Ô∏è Impossible d\'exporter en Markdown', 'error');
    }
}

console.log('‚úÖ advice.js charg√©');
